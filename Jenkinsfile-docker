def IMAGE_TAG

pipeline {
  agent { node { label 'git && docker' } }
  parameters {
    string(name: 'APP_VERSION', description: 'App version that will be used to tag Docker image')
    string(name: 'WAR_BUILD_NUMBER', description: 'Build number of WAR CI from which the WAR artifact will be taken')
  }
  stages {
    stage('Clone git repo') {
      steps {
        git branch: 'docker/main',
            credentialsId: 'jenkins-github',
            url: 'git@github.com:dima1206/WebApp.git'
      }
    }
    stage('Get WAR artifact') {
      steps {
        script {
          step ([$class: 'CopyArtifact',
              projectName: 'WebApp-CI-WAR',
              selector: specific("${params.WAR_BUILD_NUMBER}"),
              filter: "WebApp-*.war",
              target: '.']);
        }
      }
    }
    stage('Rename WAR file') {
      steps {
        sh "mv WebApp-*.war WebApp.war"
      }
    }
    stage('Build docker image') {
      steps {
        script {
          IMAGE_TAG = "${APP_VERSION}-${BUILD_NUMBER}"
          dockerImage = docker.build("dima1206/webapp:${IMAGE_TAG}")
        }
      }
    }
    stage('Push the image to Docker Hub') {
      steps {
        script {
          docker.withRegistry('', 'jenkins-dockerhub') {
            dockerImage.push()
          }
        }
      }
    }
    // TODO: clean up storage
    // TODO: trigger next pipeline
  }
}
