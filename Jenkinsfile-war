def APP_VERSION
def GIT_HASH
def WAR_ARTIFACT_FILE_NAME

pipeline {
  agent { node { label 'git && java && maven' } }
  options {
    copyArtifactPermission('WebApp-CI-Docker');
  }
  stages {
    stage('Clone git repo') {
      steps {
        git branch: 'webapp/main',
            credentialsId: 'jenkins-github',
            url: 'git@github.com:dima1206/WebApp.git'
      }
    }
    stage('Get app version, commit hash and final WAR file name') {
      steps {
        script {
          APP_VERSION = sh (script: 'mvn help:evaluate -Dexpression=project.version -q -DforceStdout', returnStdout: true).trim()
          GIT_HASH = sh (script: 'git rev-parse --short HEAD', returnStdout: true).trim()
          WAR_ARTIFACT_FILE_NAME = "WebApp-${APP_VERSION}-${GIT_HASH}.war"
        }
      }
    }
    stage('Clean target directory') {
      steps {
        sh 'mvn clean'
      }
    }
    // TODO: mvn compile (after adding java code)
    // TODO: mvn test (after creating tests)
    stage('Create WAR package') {
      steps {
        sh 'mvn package'
      }
    }
    stage('Rename WAR file') {
      steps {
        sh "mv target/WebApp.war ${WAR_ARTIFACT_FILE_NAME}"
      }
    }
    stage('Push WAR file to the S3 bucket') {
      steps {
        archiveArtifacts "${WAR_ARTIFACT_FILE_NAME}"
      }
    }
    stage('Start Docker pipeline') {
      steps {
        build job: 'WebApp-CI-Docker', parameters: [
          string(name: 'APP_VERSION', value: "${APP_VERSION}"),
          string(name: 'WAR_BUILD_NUMBER', value: "${BUILD_NUMBER}")]
      }
    }
  }
}
