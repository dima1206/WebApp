pipeline {
  agent { node { label 'webserver' } }
  parameters {
    string(name: 'IMAGE_VERSION', description: 'Version of the docker image to deploy')
  }
  stages {
    stage('Pull the image from Docker Hub') {
      steps {
        script {
          docker.withRegistry('', 'jenkins-dockerhub') {
            dockerImage = docker.image("dima1206/webapp:${IMAGE_VERSION}")
            dockerImage.pull()
          }
        }
      }
    }
    stage('Stop all containers') {
      steps {
        sh 'docker stop `docker ps -qa`'
      }
    }
    stage('Remove all containers') {
      steps {
        sh 'docker rm `docker ps -qa`'
      }
    }
    stage('Run the new container') {
      steps {
        script {
          dockerImage.run('-d -p 8080:8080')
        }
      }
    }
  }
}
