pipeline {
  agent { node { label 'webserver' } }
  parameters {
    string(name: 'IMAGE_VERSION', description: 'Version of the docker image to deploy')
  }
  stages {
    stage('Pull the image from Docker Hub') {
      steps {
        script {
          docker.withRegistry('', 'jenkins-dockerhub') {
            dockerImage = docker.image("dima1206/webapp:${IMAGE_VERSION}")
            dockerImage.pull()
          }
        }
      }
    }
    stage('Stop old container') {
      steps {
        sh 'docker ps --filter name=webapp --quiet | xargs --no-run-if-empty docker container stop'
      }
    }
    stage('Remove old container') {
      steps {
        sh 'docker container ls --all --filter name=webapp --quiet | xargs --no-run-if-empty docker container rm'
      }
    }
    stage('Run the new container') {
      steps {
        script {
          dockerImage.run('--name webapp --detach --publish 8080:8080')
        }
      }
    }
  }
}
